apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-bootstrap
data:
  01-schema.sql: |
    \set ON_ERROR_STOP on

    -- Users database
    DROP DATABASE IF EXISTS users_db WITH (FORCE);
    DROP ROLE IF EXISTS users_app;
    CREATE ROLE users_app WITH LOGIN PASSWORD 'users_pass';
    CREATE DATABASE users_db OWNER users_app;
    GRANT ALL PRIVILEGES ON DATABASE users_db TO users_app;

    \connect users_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS users;
    CREATE TABLE users (
      id UUID PRIMARY KEY,
      name TEXT NOT NULL,
      age INT NOT NULL,
      email TEXT NOT NULL UNIQUE,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO users_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO users_app;

    \connect postgres

    -- Routes database
    DROP DATABASE IF EXISTS routes_db WITH (FORCE);
    DROP ROLE IF EXISTS routes_app;
    CREATE ROLE routes_app WITH LOGIN PASSWORD 'routes_pass';
    CREATE DATABASE routes_db OWNER routes_app;
    GRANT ALL PRIVILEGES ON DATABASE routes_db TO routes_app;

    \connect routes_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS routes;
    CREATE TABLE routes (
      id UUID PRIMARY KEY,
      path TEXT NOT NULL,
      duration INT NOT NULL,
      distance INT NOT NULL,
      user_id UUID NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO routes_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO routes_app;

    \connect postgres

    -- Workouts database
    DROP DATABASE IF EXISTS workouts_db WITH (FORCE);
    DROP ROLE IF EXISTS workouts_app;
    CREATE ROLE workouts_app WITH LOGIN PASSWORD 'workouts_pass';
    CREATE DATABASE workouts_db OWNER workouts_app;
    GRANT ALL PRIVILEGES ON DATABASE workouts_db TO workouts_app;

    \connect workouts_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS workouts;
    CREATE TABLE workouts (
      id UUID PRIMARY KEY,
      name TEXT NOT NULL,
      exercises JSONB NOT NULL,
      duration INT NOT NULL,
      calories INT NOT NULL,
      date TIMESTAMPTZ NOT NULL,
      user_id UUID NOT NULL,
      route_id UUID NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO workouts_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO workouts_app;

    \connect postgres

    -- Reviews database
    DROP DATABASE IF EXISTS reviews_db WITH (FORCE);
    DROP ROLE IF EXISTS reviews_app;
    CREATE ROLE reviews_app WITH LOGIN PASSWORD 'reviews_pass';
    CREATE DATABASE reviews_db OWNER reviews_app;
    GRANT ALL PRIVILEGES ON DATABASE reviews_db TO reviews_app;

    \connect reviews_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS reviews;
    CREATE TABLE reviews (
      id UUID PRIMARY KEY,
      user_id UUID NOT NULL,
      route_id UUID NOT NULL,
      rating INT NOT NULL,
      comment TEXT NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO reviews_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO reviews_app;

    \connect postgres

    -- Leaderboard database
    DROP DATABASE IF EXISTS leaderboard_db WITH (FORCE);
    DROP ROLE IF EXISTS leaderboard_app;
    CREATE ROLE leaderboard_app WITH LOGIN PASSWORD 'leaderboard_pass';
    CREATE DATABASE leaderboard_db OWNER leaderboard_app;
    GRANT ALL PRIVILEGES ON DATABASE leaderboard_db TO leaderboard_app;

    \connect leaderboard_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS leaderboard;
    CREATE TABLE leaderboard (
      id UUID PRIMARY KEY,
      user_id UUID NOT NULL,
      score INT NOT NULL,
      position INT NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO leaderboard_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO leaderboard_app;

    \connect postgres

    -- Notifications database
    DROP DATABASE IF EXISTS notifications_db WITH (FORCE);
    DROP ROLE IF EXISTS notifications_app;
    CREATE ROLE notifications_app WITH LOGIN PASSWORD 'notifications_pass';
    CREATE DATABASE notifications_db OWNER notifications_app;
    GRANT ALL PRIVILEGES ON DATABASE notifications_db TO notifications_app;

    \connect notifications_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS notifications;
    CREATE TABLE notifications (
      id UUID PRIMARY KEY,
      user_id UUID NOT NULL,
      message TEXT NOT NULL,
      read BOOLEAN NOT NULL DEFAULT FALSE,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO notifications_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO notifications_app;

    \connect postgres

    -- Maps database
    DROP DATABASE IF EXISTS maps_db WITH (FORCE);
    DROP ROLE IF EXISTS maps_app;
    CREATE ROLE maps_app WITH LOGIN PASSWORD 'maps_pass';
    CREATE DATABASE maps_db OWNER maps_app;
    GRANT ALL PRIVILEGES ON DATABASE maps_db TO maps_app;

    \connect maps_db

    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    DROP TABLE IF EXISTS maps;
    CREATE TABLE maps (
      id UUID PRIMARY KEY,
      route_id UUID NOT NULL,
      geojson JSONB NOT NULL,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO maps_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO maps_app;

    \connect postgres
  02-seed.sql: |
    \set ON_ERROR_STOP on

    \connect users_db
    TRUNCATE TABLE users;
    INSERT INTO users (id, name, age, email, created_at) VALUES
      ('11111111-1111-1111-1111-111111111111', 'Alicia Campos', 28, 'alicia@example.com', NOW()),
      ('22222222-2222-2222-2222-222222222222', 'Bruno Serrano', 32, 'bruno@example.com', NOW()),
      ('33333333-3333-3333-3333-333333333333', 'Carla Nuñez', 25, 'carla@example.com', NOW());

    \connect postgres

    \connect routes_db
    TRUNCATE TABLE routes;
    INSERT INTO routes (id, path, duration, distance, user_id, created_at) VALUES
      ('44444444-4444-4444-4444-444444444444', 'Sendero Bosque Encantado', 95, 21, '11111111-1111-1111-1111-111111111111', NOW()),
      ('55555555-5555-5555-5555-555555555555', 'Ruta Laguna Azul', 120, 30, '22222222-2222-2222-2222-222222222222', NOW()),
      ('66666666-6666-6666-6666-666666666666', 'Ascenso Pico Norte', 150, 18, '33333333-3333-3333-3333-333333333333', NOW());

    \connect postgres

    \connect workouts_db
    TRUNCATE TABLE workouts;
    INSERT INTO workouts (id, name, exercises, duration, calories, date, user_id, route_id, created_at) VALUES
      ('77777777-7777-7777-7777-777777777777', 'Entrenamiento Montaña', '["Calentamiento","Trail Run","Estiramiento"]'::jsonb, 85, 950, '2024-06-15T09:00:00Z', '11111111-1111-1111-1111-111111111111', '44444444-4444-4444-4444-444444444444', NOW()),
      ('88888888-8888-8888-8888-888888888888', 'Rodada Alpina', '["Bicicleta","Sprints","Core"]'::jsonb, 70, 780, '2024-07-02T07:30:00Z', '22222222-2222-2222-2222-222222222222', '55555555-5555-5555-5555-555555555555', NOW());

    \connect postgres

    \connect reviews_db
    TRUNCATE TABLE reviews;
    INSERT INTO reviews (id, user_id, route_id, rating, comment, created_at) VALUES
      ('99999999-9999-9999-9999-999999999999', '11111111-1111-1111-1111-111111111111', '55555555-5555-5555-5555-555555555555', 5, 'Ruta espectacular, vistas increíbles.', NOW()),
      ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', '22222222-2222-2222-2222-222222222222', '44444444-4444-4444-4444-444444444444', 4, 'Buena señalización, pero terreno exigente.', NOW()),
      ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', '33333333-3333-3333-3333-333333333333', '66666666-6666-6666-6666-666666666666', 3, 'Bonitas vistas, aunque el clima no ayudó.', NOW());

    \connect postgres

    \connect leaderboard_db
    TRUNCATE TABLE leaderboard;
    INSERT INTO leaderboard (id, user_id, score, position, created_at) VALUES
      ('13131313-1313-1313-1313-131313131313', '11111111-1111-1111-1111-111111111111', 1200, 1, NOW()),
      ('14141414-1414-1414-1414-141414141414', '22222222-2222-2222-2222-222222222222', 980, 2, NOW()),
      ('15151515-1515-1515-1515-151515151515', '33333333-3333-3333-3333-333333333333', 860, 3, NOW());

    \connect postgres

    \connect notifications_db
    TRUNCATE TABLE notifications;
    INSERT INTO notifications (id, user_id, message, read, created_at) VALUES
      ('cccccccc-cccc-cccc-cccc-cccccccccccc', '11111111-1111-1111-1111-111111111111', 'Recuerda hidratarte antes del entrenamiento.', FALSE, NOW()),
      ('dddddddd-dddd-dddd-dddd-dddddddddddd', '22222222-2222-2222-2222-222222222222', 'Nuevo segmento disponible en Ruta Laguna Azul.', TRUE, NOW()),
      ('eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee', '33333333-3333-3333-3333-333333333333', 'Has subido al puesto 3 del leaderboard.', FALSE, NOW());

    \connect postgres

    \connect maps_db
    TRUNCATE TABLE maps;
    INSERT INTO maps (id, route_id, geojson, created_at) VALUES
      ('ffffffff-ffff-ffff-ffff-ffffffffffff', '44444444-4444-4444-4444-444444444444', '{"type":"Feature","properties":{"color":"#22c55e","label":"Sendero Bosque Encantado"},"geometry":{"type":"LineString","coordinates":[[-99.135,19.40],[-99.13,19.42],[-99.125,19.435],[-99.12,19.45]]}}'::jsonb, NOW()),
      ('12121212-1212-1212-1212-121212121212', '55555555-5555-5555-5555-555555555555', '{"type":"Feature","properties":{"color":"#0ea5e9","label":"Ruta Laguna Azul"},"geometry":{"type":"LineString","coordinates":[[-99.21,19.29],[-99.20,19.31],[-99.19,19.34],[-99.18,19.37],[-99.17,19.395]]}}'::jsonb, NOW()),
      ('23232323-2323-2323-2323-232323232323', '66666666-6666-6666-6666-666666666666', '{"type":"Feature","properties":{"color":"#f97316","label":"Ascenso Pico Norte"},"geometry":{"type":"LineString","coordinates":[[-99.07,19.48],[-99.065,19.5],[-99.06,19.525],[-99.055,19.55],[-99.05,19.565]]}}'::jsonb, NOW());

    \connect postgres
